<!DOCTYPE html>
<html lang="ru">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Карта</title>
<style>
    body, html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        touch-action: none; /* Полный контроль касаний */
        background: #000;
    }

    #container {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        position: relative;
        background: #111;
    }

    #map {
        position: absolute;
        left: 0;
        top: 0;
        transform-origin: 0 0;
        user-select: none;
        touch-action: none;
        will-change: transform;
    }
</style>
</head>
<body>

<div id="container">
    <img id="map" src="map-big.jpg" alt="Map">
</div>

<script>
const container = document.getElementById("container");
const map = document.getElementById("map");

let posX = 0, posY = 0;
let lastX = 0, lastY = 0;

let scale = 1;
let lastScale = 1;

let startDistance = 0;
let startMid = { x: 0, y: 0 };

let isDragging = false;

// ---- Ограничение перемещений ----
function clampPosition() {
    const rect = container.getBoundingClientRect();
    const mapWidth = map.naturalWidth * scale;
    const mapHeight = map.naturalHeight * scale;

    const minX = Math.min(0, rect.width - mapWidth);
    const minY = Math.min(0, rect.height - mapHeight);

    posX = Math.min(0, Math.max(minX, posX));
    posY = Math.min(0, Math.max(minY, posY));
}

// ---- Применение трансформации ----
function updateTransform() {
    clampPosition();
    map.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
}

// ---- Расстояние между пальцами ----
function distance(p1, p2) {
    return Math.hypot(p2.clientX - p1.clientX, p2.clientY - p1.clientY);
}

// ---- Центральная точка между пальцами ----
function midpoint(p1, p2) {
    return {
        x: (p1.clientX + p2.clientX) / 2,
        y: (p1.clientY + p2.clientY) / 2
    };
}

container.addEventListener("touchstart", (e) => {
    if (e.touches.length === 1) {
        // Перемещение
        isDragging = true;
        lastX = e.touches[0].clientX - posX;
        lastY = e.touches[0].clientY - posY;
    }

    if (e.touches.length === 2) {
        // Зум
        isDragging = false;
        startDistance = distance(e.touches[0], e.touches[1]);
        startMid = midpoint(e.touches[0], e.touches[1]);
        lastScale = scale;
    }
});

container.addEventListener("touchmove", (e) => {
    e.preventDefault();

    if (e.touches.length === 1 && isDragging) {
        posX = e.touches[0].clientX - lastX;
        posY = e.touches[0].clientY - lastY;
        updateTransform();
    }

    if (e.touches.length === 2) {
        const newDist = distance(e.touches[0], e.touches[1]);
        const zoom = newDist / startDistance;

        scale = Math.min(4, Math.max(1, lastScale * zoom));

        // Точка зума — центр между пальцами
        const mid = midpoint(e.touches[0], e.touches[1]);

        posX -= (mid.x - posX) * (scale / lastScale - 1);
        posY -= (mid.y - posY) * (scale / lastScale - 1);

        updateTransform();
    }
});

container.addEventListener("touchend", () => {
    if (event.touches.length === 0) isDragging = false;
});
</script>

</body>
</html>
